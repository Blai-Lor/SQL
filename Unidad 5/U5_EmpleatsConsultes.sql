CREATE TABLE TIPUS_PLACA (
    NOM VARCHAR2(50) PRIMARY KEY,
    FUNCIO VARCHAR2(200) NOT NULL
);

CREATE TABLE PLACA (
    CODI NUMBER GENERATED AS IDENTITY PRIMARY KEY,
    NOM VARCHAR2(50) NOT NULL,
    SALARI NUMBER(10,2) NOT NULL,
    INFORME_SUPERVISIO VARCHAR2(1000),
    CODI_PLACA_SUPERVISORA NUMBER,
    NOM_TIPUS_PLACA VARCHAR2(50) NOT NULL,
    FOREIGN KEY (CODI_PLACA_SUPERVISORA) REFERENCES PLACA (CODI),
    FOREIGN KEY (NOM_TIPUS_PLACA) REFERENCES TIPUS_PLACA (NOM)
);

CREATE TABLE EMPLEAT (
    NSS NUMBER(12) PRIMARY KEY,
    NOM VARCHAR2(50) NOT NULL,
    LLINATGES VARCHAR2(100) NOT NULL,
    EMAIL VARCHAR2(100),
    IBAN VARCHAR2(24) UNIQUE NOT NULL CHECK (IBAN LIKE 'ES%')
);

CREATE TABLE OCUPA (
    NSS_EMPLEAT NUMBER(12) NOT NULL,
    CODI_PLACA NUMBER(10) NOT NULL,
    DATA_INICI DATE NOT NULL,
    DATA_FI DATE,
    PRIMARY KEY (NSS_EMPLEAT, CODI_PLACA),
    FOREIGN KEY (NSS_EMPLEAT) REFERENCES EMPLEAT (NSS),
    FOREIGN KEY (CODI_PLACA) REFERENCES PLACA (CODI)
);

CREATE TABLE NOMINA (
    ID_NOMINA NUMBER GENERATED AS IDENTITY PRIMARY KEY,
    IBAN_PAGAMENT VARCHAR2(24) NOT NULL,
    IMPORT NUMBER(7,2) NOT NULL,
    NSS_EMPLEAT NUMBER(12) NOT NULL,
    CODI_PLACA NUMBER(10) NOT NULL,
    FOREIGN KEY (NSS_EMPLEAT) REFERENCES EMPLEAT (NSS),
    FOREIGN KEY (CODI_PLACA) REFERENCES PLACA (CODI)
);

-- TIPUS_PLACA
INSERT INTO TIPUS_PLACA VALUES ('Administrativa', 'Gestió administrativa i documentació');
INSERT INTO TIPUS_PLACA VALUES ('Tecnica', 'Tasques tècniques especialitzades');
INSERT INTO TIPUS_PLACA VALUES ('Supervisio', 'Supervisió d''equips i processos');
INSERT INTO TIPUS_PLACA VALUES ('Direccio', 'Direcció estratègica i presa de decisions');
INSERT INTO TIPUS_PLACA VALUES ('Suport', 'Suport intern i assistència general');

-- PLACA (primer sense supervisora)
INSERT INTO PLACA (NOM, SALARI, INFORME_SUPERVISIO, CODI_PLACA_SUPERVISORA, NOM_TIPUS_PLACA)
VALUES ('Cap Direccio', 5000, 'Informe general de direcció', NULL, 'Direccio');

INSERT INTO PLACA (NOM, SALARI, INFORME_SUPERVISIO, CODI_PLACA_SUPERVISORA, NOM_TIPUS_PLACA)
VALUES ('Supervisor Tecnic', 3800, 'Control de qualitat tècnica', 1, 'Supervisio');

INSERT INTO PLACA (NOM, SALARI, INFORME_SUPERVISIO, CODI_PLACA_SUPERVISORA, NOM_TIPUS_PLACA)
VALUES ('Tecnica Senior', 3200, 'Tasques tècniques avançades', 2, 'Tecnica');

INSERT INTO PLACA (NOM, SALARI, INFORME_SUPERVISIO, CODI_PLACA_SUPERVISORA, NOM_TIPUS_PLACA)
VALUES ('Administrativa RRHH', 2500, 'Gestió de personal', 1, 'Administrativa');

INSERT INTO PLACA (NOM, SALARI, INFORME_SUPERVISIO, CODI_PLACA_SUPERVISORA, NOM_TIPUS_PLACA)
VALUES ('Suport IT', 2200, 'Assistència informàtica interna', 2, 'Suport');

-- EMPLEAT
INSERT INTO EMPLEAT VALUES (111111111111, 'Joan', 'Garcia Pons', 'joan.garcia@empresa.cat', 'ES9121000418450200051332');
INSERT INTO EMPLEAT VALUES (222222222222, 'Maria', 'López Serra', 'maria.lopez@empresa.cat', 'ES9820385778983000760236');
INSERT INTO EMPLEAT VALUES (333333333333, 'Pere', 'Martí Vidal', 'pere.marti@empresa.cat', 'ES7921000813610123456789');
INSERT INTO EMPLEAT VALUES (444444444444, 'Laura', 'Riera Bosch', 'laura.riera@empresa.cat', 'ES6621000418401234567891');
INSERT INTO EMPLEAT VALUES (555555555555, 'Anna', 'Ferrer Mas', 'anna.ferrer@empresa.cat', 'ES4521000418459876543210');

-- OCUPA
INSERT INTO OCUPA VALUES (111111111111, 1, DATE '2022-01-01', NULL);
INSERT INTO OCUPA VALUES (222222222222, 2, DATE '2022-03-01', NULL);
INSERT INTO OCUPA VALUES (333333333333, 3, DATE '2023-01-15', NULL);
INSERT INTO OCUPA VALUES (444444444444, 4, DATE '2021-09-01', NULL);
INSERT INTO OCUPA VALUES (555555555555, 5, DATE '2023-06-01', NULL);

-- NOMINA
INSERT INTO NOMINA (IBAN_PAGAMENT, IMPORT, NSS_EMPLEAT, CODI_PLACA)
VALUES ('ES9121000418450200051332', 5000, 111111111111, 1);

INSERT INTO NOMINA (IBAN_PAGAMENT, IMPORT, NSS_EMPLEAT, CODI_PLACA)
VALUES ('ES9820385778983000760236', 3800, 222222222222, 2);

INSERT INTO NOMINA (IBAN_PAGAMENT, IMPORT, NSS_EMPLEAT, CODI_PLACA)
VALUES ('ES7921000813610123456789', 3200, 333333333333, 3);

INSERT INTO NOMINA (IBAN_PAGAMENT, IMPORT, NSS_EMPLEAT, CODI_PLACA)
VALUES ('ES6621000418401234567891', 2500, 444444444444, 4);

INSERT INTO NOMINA (IBAN_PAGAMENT, IMPORT, NSS_EMPLEAT, CODI_PLACA)
VALUES ('ES4521000418459876543210', 2200, 555555555555, 5);

-- 1. Temps, en anys (amb decimals) que cada empleat (NSS) ha estat a cada plaça (codi).
SELECT NSS_EMPLEAT, CODI_PLACA, ABS(MONTHS_BETWEEN(DATA_INICI, DATA_FI)) / 12 FROM OCUPA;
-- 2. Salari mitjà de les places que són supervisades per cada plaça supervisora. Columnes: ID plaça supervisora, salari mitjà de les places que supervisa.
SELECT CODI_PLACA_SUPERVISORA, AVG(SALARI) FROM PLACA WHERE CODI_PLACA IS NOT NULL GROUP BY CODI_PLACA_SUPERVISORA;
-- 3. Nom i salari de les places que no tenen plaça supervisora.
SELECT NOM, SALARI FROM PLACA WHERE CODI_PLACA_SUPERVISORA IS NULL;
-- 4. Periode promig d'ocupació d'una plaça per qualsevol empleat.
SELECT AVG(ABS(MONTHS_BETWEEN(DATA_INICI, DATA_FI))) FROM OCUPA;
-- 5. Salari màxim i mínim per tipus de plaça.
SELECT NOM_TIPUS_PLACA, MIN(SALARI) AS salari_minim, MAX(SALARI) AS salari_maxim FROM PLACA GROUP BY NOM_TIPUS_PLACA;
-- 6. Salari màxim i mínim per tipus de plaça, sempre que el salari mitjà del tipus de plaça sigui superior a 3000.
SELECT NOM_TIPUS_PLACA, MIN(SALARI) AS salari_minim, MAX(SALARI) AS salari_maxim FROM PLACA GROUP BY NOM_TIPUS_PLACA HAVING AVG(salari)>3000;
-- 7. Número de places del tipus de plaça que més cobra.
SELECT COUNT(*) FROM PLACA GROUP BY NOM_TIPUS_PLACA ORDER BY AVG(SALARI) DESC FETCH FIRST ROW ONLY;